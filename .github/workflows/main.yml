name: Build ZX Spectrum Tools

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==============================================================
  # JOB 1: Build for Windows x64, macOS, and Linux x86_64
  # ==============================================================
  build-native:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4

    # Build txt2bas
    - name: Configure CMake (txt2bas)
      run: cmake -S ./cpp/txt2bas -B ./build/txt2bas -DCMAKE_BUILD_TYPE=Release

    - name: Build txt2bas
      run: cmake --build ./build/txt2bas --config Release

    # Build bas2txt
    - name: Configure CMake (bas2txt)
      run: cmake -S ./cpp/bas2txt -B ./build/bas2txt -DCMAKE_BUILD_TYPE=Release

    - name: Build bas2txt
      run: cmake --build ./build/bas2txt --config Release

    # Organize binaries into a staging area to control the ZIP structure
    - name: Stage Binaries
      shell: bash
      run: |
        mkdir -p staging/txt2bas staging/bas2txt
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          # Check Release folder (MSVC) or root build folder (MinGW)
          cp build/txt2bas/Release/txt2bas.exe staging/txt2bas/ 2>/dev/null || cp build/txt2bas/txt2bas.exe staging/txt2bas/
          cp build/bas2txt/Release/bas2txt.exe staging/bas2txt/ 2>/dev/null || cp build/bas2txt/bas2txt.exe staging/bas2txt/
        else
          cp build/txt2bas/txt2bas staging/txt2bas/
          cp build/bas2txt/bas2txt staging/bas2txt/
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zx-tools-${{ matrix.os }}
        path: staging/

  # ==============================================================
  # JOB 2: Build for Linux ARM64 (Using Debian 11 Container)
  # ==============================================================
  build-linux-arm64:
    name: Build on Linux ARM64 (Debian 11)
    runs-on: ubuntu-latest
    
    container:
      image: debian:11

    steps:
    - name: Install Build Tools & ARM64 Toolchain
      run: |
        apt-get update
        apt-get install -y git cmake make gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Checkout Source Code
      uses: actions/checkout@v4

    # Build txt2bas (ARM64)
    - name: Configure CMake for ARM64 (txt2bas)
      run: >
        cmake -S $GITHUB_WORKSPACE/cpp/txt2bas -B $GITHUB_WORKSPACE/build/txt2bas 
        -DCMAKE_BUILD_TYPE=Release 
        -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ 
        -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc

    - name: Build txt2bas
      run: cmake --build $GITHUB_WORKSPACE/build/txt2bas --config Release

    # Build bas2txt (ARM64)
    - name: Configure CMake for ARM64 (bas2txt)
      run: >
        cmake -S $GITHUB_WORKSPACE/cpp/bas2txt -B $GITHUB_WORKSPACE/build/bas2txt 
        -DCMAKE_BUILD_TYPE=Release 
        -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ 
        -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc

    - name: Build bas2txt
      run: cmake --build $GITHUB_WORKSPACE/build/bas2txt --config Release

    # Organize binaries for ARM64
    - name: Stage Binaries
      run: |
        mkdir -p staging/txt2bas staging/bas2txt
        cp $GITHUB_WORKSPACE/build/txt2bas/txt2bas staging/txt2bas/
        cp $GITHUB_WORKSPACE/build/bas2txt/bas2txt staging/bas2txt/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zx-tools-linux-arm64
        path: staging/
